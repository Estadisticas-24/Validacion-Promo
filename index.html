<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Promorack y Cambios</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: url('fondo.png') no-repeat center center fixed;
            background-size: cover;
            background-attachment: fixed;
            background-color: #f7f7f7;
            margin: 0;
            padding: 20px;
        }
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .tabs button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            margin: 0 10px;
            border-radius: 5px;
        }
        .tabs button.active {
            background-color: #0056b3;
        }
        .tabs button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .container {
            max-width: 600px;
            width: 100%;
            background: rgba(255, 255, 255, 0.815);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            display: none;
            overflow-y: auto;
            max-height: 80vh;
        }
        .container.active {
            display: block;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        label {
            display: block;
            margin: 15px 0 5px;
        }
        select, input, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[readonly] {
            background-color: #f4f4f9;
        }
        button {
            color: black;
            border: none;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .btn-desactivar {
            background-color: red;
        }
        .btn-activar {
            background-color: green;
        }
        #resultado, #resultadoCambios {
            text-align: center;
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .aplica {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .no-aplica {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .highlight-background {
            background-color: #f8d7da !important;
            color: red !important;
            border: 1px solid red !important;
            padding: 5px;
            border-radius: 4px;
        }
        .list-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.815);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 50vh;
        }
        .list-container table {
            width: 100%;
            border-collapse: collapse;
        }
        .list-container th, .list-container td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }
        .list-container th {
            background-color: #007BFF;
            color: white;
        }
        .remove-button {
            background-color: #FF0000;
            color: white;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .remove-button:hover {
            background-color: #b30000;
        }
        .download-button {
            background-color: #007BFF;
        }
        .download-button:hover {
            background-color: #0056b3;
        }
        #contadorPromorack, #contadorCambios {
            color: red;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .clear-button {
            background-color: #FFA500;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 4px;
        }
        .clear-button:hover {
            background-color: #cc8400;
        }
    </style>
</head>
<body>
    <div class="tabs">
        <button id="tabPromorack" class="active">Validación de Promorack</button>
        <button id="tabCambios">Cambios</button>
    </div>

    <div id="containerPromorack" class="container active">
        <h1>Validación de Promorack</h1>
        <label for="centro">Centro (Nomenclatura):</label>
        <select id="centro">
            <option value="">Selecciona un centro</option>
        </select>
        <br>
        <label for="jefeZona">Jefe de Zona:</label>
        <select id="jefeZona" disabled>
            <option value="">Selecciona un jefe de zona</option>
        </select>
        <br>
        <label for="cliente">Códigos de Cliente:</label>
        <select id="cliente" disabled>
            <option value="">Selecciona un cliente</option>
        </select>
        <br>
        <label for="ruta">Ruta:</label>
        <input type="text" id="ruta" readonly>
        <br>
        <label for="nombreNegocio">Nombre de Cliente:</label>
        <input type="text" id="nombreNegocio" readonly>
        <br>
        <label for="nombreCliente">Nombre de Negocio:</label>
        <input type="text" id="nombreCliente" readonly>
        <br>
        <label for="tipoCluster">Tipo de Cluster:</label>
        <input type="text" id="tipoCluster" readonly>
        <br>
        <button id="verificar" disabled>Verificar</button>
        <p id="resultado"></p>
        <p id="mensaje" class="detalle"></p> 
        <button id="agregar" disabled>Agregar</button>
        <button id="descargarExcel" class="download-button" disabled>Descargar Excel</button>
        <button id="vaciarTablaPromorack" class="clear-button">Vaciar Tabla</button>
        <p id="mensajeRepetido" style="color: red; display: none;">Código de cliente ya agregado.</p>
    </div>

    <div id="containerCambios" class="container">
        <h1>Cambios</h1>
        <label for="centroCambios">Centro (Nomenclatura):</label>
        <select id="centroCambios">
            <option value="">Selecciona un centro</option>
        </select>
        <br>
        <label for="jefeZonaCambios">Jefe de Zona:</label>
        <select id="jefeZonaCambios" disabled>
            <option value="">Selecciona un jefe de zona</option>
        </select>
        <br>
        <label for="clienteCambios">Códigos de Cliente:</label>
        <select id="clienteCambios" disabled>
            <option value="">Selecciona un cliente</option>
        </select>
        <br>
        <label for="rutaCambios">Ruta:</label>
        <input type="text" id="rutaCambios" readonly>
        <br>
        <button id="verificarCambios" class="btn-activar" style="display: none;" disabled>Verificar</button>
        <button id="agregarCambios" class="btn-desactivar" disabled>Desactivar</button>
        <p id="resultadoCambios"></p>
        <p id="mensajeCambios" class="detalle"></p>
        <button id="descargarExcelCambios" class="download-button" disabled>Descargar Excel</button>
        <button id="vaciarTablaCambios" class="clear-button">Vaciar Tabla</button>
    </div>

    <div class="list-container">
        <h2 id="tituloClientesAgregados">Clientes Agregados<span id="contadorPromorack">: 0</span></h2>
        <table id="clientesAgregados">
            <thead>
                <tr>
                    <th>Centro</th>
                    <th>Jefe de Zona</th>
                    <th>Ruta</th>
                    <th>Código de Cliente</th>
                    <th>Nombre de Cliente</th>
                    <th>Nombre de Negocio</th>
                    <th>Acción</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se agregarán los clientes -->
            </tbody>
        </table>
    </div>

    <script>
        let clientesAgregados = [];
        let contadorPromorack = 0;
        let estadoBoton = 'Desactivar';
        let contadorCambios = 0;

        // Estado para reglas de restricción/cluster
        let clusterRawActual = '';
        let codigoClienteActual = '';
        let allowAgregarPromorack = false;
        let accionOverridePromorack = null; // e.g. 'Sujeto a autorización de dirección comercial'

        async function loadData() {
            try {
                const responseClientes = await fetch('clientes_segmentacion.json');
                const clientesSegmentacion = await responseClientes.json();

                const responseCambios = await fetch('cambios.json');
                const cambiosData = await responseCambios.json();

                const responseRestricciones = await fetch('restricciones.json');
                const restricciones = await responseRestricciones.json();

                cargarDatosPromorack(clientesSegmentacion, restricciones);
                cargarDatosCambios(cambiosData, clientesSegmentacion, restricciones);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function cargarDatosPromorack(clientesSegmentacion, restricciones) {
            const centros = [...new Set(clientesSegmentacion.map(item => item.Centro))];
            const centroSelect = $('#centro');

            centros.forEach(centro => centroSelect.append(new Option(centro, centro)));

            centroSelect.select2().on('change', function() {
                const selectedCentro = $(this).val();
                const jefeZonaSelect = $('#jefeZona');

                jefeZonaSelect.empty().append('<option value="">Selecciona un jefe de zona</option>');
                $('#cliente').empty().append('<option value="">Selecciona un cliente</option>').prop('disabled', true);
                resetInputStyles();
                disableFields(['#jefeZona', '#cliente']);

                if (selectedCentro) {
                    const jefesZona = [...new Set(clientesSegmentacion
                        .filter(item => item.Centro === selectedCentro)
                        .map(item => item.Jefe_Zona))];

                    jefesZona.forEach(j => jefeZonaSelect.append(new Option(j, j)));
                    jefeZonaSelect.prop('disabled', false).select2();
                }
            });

            $('#jefeZona').select2().on('change', function() {
                const selectedCentro = $('#centro').val();
                const selectedJefeZona = $(this).val();
                const clienteSelect = $('#cliente');

                clienteSelect.empty().append('<option value="">Selecciona un cliente</option>');
                resetInputStyles();
                disableFields(['#cliente']);

                if (selectedCentro && selectedJefeZona) {
                    const clientes = [...new Set(clientesSegmentacion
                        .filter(item => item.Centro === selectedCentro && item.Jefe_Zona === selectedJefeZona)
                        .map(item => item.Codigo_Cliente_HTML))];

                    clientes.forEach(c => clienteSelect.append(new Option(c, c)));

                    clienteSelect.prop('disabled', false).select2();
                    $('#agregar').prop('disabled', true);
                    $('#verificar').prop('disabled', true);
                }
            });

            // --------- ÚNICO handler de cambio de cliente (sin duplicados) ---------
            $('#cliente').select2().on('change', function() {
                const selectedCentro = $('#centro').val();
                const selectedJefeZona = $('#jefeZona').val();
                const selectedCliente = $(this).val();

                if (!selectedCliente) {
                    $('#ruta').val('');
                    $('#nombreNegocio').val('');
                    $('#nombreCliente').val('');
                    $('#tipoCluster').val('');
$('#resultado').hide();
                    $('#agregar').prop('disabled', true);
                    $('#verificar').prop('disabled', true);
                    $('#mensaje').hide();
                    resetInputStyles();
                    allowAgregarPromorack = false;
                    accionOverridePromorack = null;
                    clusterRawActual = '';
                    codigoClienteActual = '';
                    return;
                }

                const selectedClienteTruncado = selectedCliente.slice(0, 13);

                const combina = clientesSegmentacion.filter(item => 
                    item.Centro === selectedCentro && 
                    item.Jefe_Zona === selectedJefeZona &&
                    item.Codigo_Cliente_HTML.slice(0, 13) === selectedClienteTruncado
                );

                const resultadoElement = $('#resultado');
                const agregarButton = $('#agregar');
                const mensajeElement = $('#mensaje');
                const verificarButton = $('#verificar');

                if (combina.length === 0) {
                    resultadoElement.text('No Aplica: Cliente no encontrado en la base de datos')
                        .removeClass('aplica').addClass('no-aplica').show();
                    agregarButton.prop('disabled', true);
                    verificarButton.prop('disabled', true);
                    mensajeElement.hide();

                    $('#nombreNegocio').addClass('highlight-background');
                    $('#nombreCliente').addClass('highlight-background');
                    $('#tipoCluster').addClass('highlight-background');
return;
                }

                const clienteData = combina[0];

                // Guardar estado actual para validación/agregado
                clusterRawActual = (clienteData['Tipo_de_Cluster'] || '');
                codigoClienteActual = selectedClienteTruncado;
                allowAgregarPromorack = false;
                accionOverridePromorack = null;

                // Cargar campos base
                $('#ruta').val(clienteData['Ruta']);
                $('#nombreNegocio').val(clienteData['Nombre_de_Cliente']);
                $('#nombreCliente').val(clienteData['Nombre_de_Negocio']);
// Detectar si tiene restricción "Razón Social"
                const restr = restricciones.find(r => r.Codigo === selectedClienteTruncado);
                const esRazonSocial = restr && (restr.No_Aplica_Por || "").toLowerCase().includes("razón social");

                // Si es Razón Social, en tipoCluster debe verse SOLO "Razón Social"
                // Tipo de Cluster: SIEMPRE mostrar el cluster real
                $('#tipoCluster').val(clienteData['Tipo_de_Cluster']);

                // Resaltado: mantener/optimizar O Razón Social
                const cluster = (clienteData['Tipo_de_Cluster'] || "").toLowerCase();
                const esMantOpt = (cluster === 'mantener' || cluster === 'optimizar');

                resetInputStyles();

                if (esMantOpt || esRazonSocial) {
                    $('#tipoCluster').addClass('highlight-background');
                }

                if (esRazonSocial) {
                    $('#nombreNegocio').addClass('highlight-background');
                    $('#nombreCliente').addClass('highlight-background');
}

                resultadoElement.hide();
                agregarButton.prop('disabled', true);
                verificarButton.prop('disabled', false);
                mensajeElement.hide();
            });

            $('#verificar').on('click', function() {
                const selectedCliente = $('#cliente').val();
                if (!selectedCliente) return;

                const selectedClienteTruncado = selectedCliente.slice(0, 13);

                const restriccionesCliente = restricciones.find(item => item.Codigo === selectedClienteTruncado);
                const resultadoElement = $('#resultado');
                const agregarButton = $('#agregar');
                const mensajeElement = $('#mensaje');

                // Reset estado por defecto
                allowAgregarPromorack = false;
                accionOverridePromorack = null;

                // Cluster real del cliente (no el texto forzado en el input)
                const cluster = (clusterRawActual || $('#tipoCluster').val() || '').toLowerCase();
                const esMantOpt = (cluster === 'mantener' || cluster === 'optimizar');

                if (restriccionesCliente) {
                    const motivo = (restriccionesCliente.No_Aplica_Por || '');
                    const esRazonSocial = motivo.toLowerCase().includes('razón social') || motivo.toLowerCase().includes('razon social');

                    // --- NUEVAS REGLAS ---
                    // 1) Si el motivo es Razón Social:
                    //    - Si el cluster es Mantener/Optimizar -> SE PERMITE agregar,
                    //      y se marca como "Sujeto a autorización de dirección comercial".
                    //    - En otros casos -> NO se permite agregar.
                    // 2) Para otros motivos de restricción:
                    //    - Si el cluster es Mantener/Optimizar -> SE PERMITE agregar (excepción).
                    //    - En otros casos -> NO se permite agregar.

                    if (esRazonSocial) {
                        if (esMantOpt) {
                            resultadoElement
                                .text('Aplica: Sujeto a autorización de dirección comercial')
                                .removeClass('no-aplica').addClass('aplica').show();

                            allowAgregarPromorack = true;
                            accionOverridePromorack = 'Sujeto a autorización de dirección comercial';

                            // Mantener resaltado de campos sensibles por Razón Social
                            $('#nombreNegocio').addClass('highlight-background');
                            $('#nombreCliente').addClass('highlight-background');
                            $('#tipoCluster').addClass('highlight-background');
agregarButton.prop('disabled', false);
                            mensajeElement.hide();
                        } else {
                            resultadoElement
                                .text('No Aplica: ' + motivo)
                                .removeClass('aplica').addClass('no-aplica').show();

                            allowAgregarPromorack = false;
                            agregarButton.prop('disabled', true);

                            mensajeElement.show();

                            // Resaltar siempre si hay restricción
                            $('#nombreNegocio').addClass('highlight-background');
                            $('#nombreCliente').addClass('highlight-background');
                            $('#tipoCluster').addClass('highlight-background');
// Forzar el campo a "Razón Social" cuando aplique
                            $('#tipoCluster').val('Razón Social');
                        }
                    } else {
                        if (esMantOpt) {
                            resultadoElement
                                .text('Aplica (Excepción Mantener/Optimizar): ' + motivo)
                                .removeClass('no-aplica').addClass('aplica').show();

                            allowAgregarPromorack = true;
                            accionOverridePromorack = null;

                            // Resaltar el cluster porque es Mantener/Optimizar
                            $('#tipoCluster').addClass('highlight-background');

                            agregarButton.prop('disabled', false);
                            mensajeElement.hide();
                        } else {
                            resultadoElement
                                .text('No Aplica: ' + motivo)
                                .removeClass('aplica').addClass('no-aplica').show();

                            allowAgregarPromorack = false;
                            agregarButton.prop('disabled', true);
                            mensajeElement.show();

                            // Resaltar siempre si hay restricción
                            $('#nombreNegocio').addClass('highlight-background');
                            $('#nombreCliente').addClass('highlight-background');
                            $('#tipoCluster').addClass('highlight-background');
}
                    }
                } else {
                    resultadoElement.text('Aplica').removeClass('no-aplica').addClass('aplica').show();
                    allowAgregarPromorack = true;
                    accionOverridePromorack = null;

                    agregarButton.prop('disabled', false);
                    mensajeElement.hide();

                    // Quitar resaltado
                    resetInputStyles();
                }
            });

            function esCodigoRepetido(codigoCliente) {
                return clientesAgregados.some(cliente => cliente.Codigo_Cliente === codigoCliente);
            }

            $('#agregar').on('click', function() {
                const centro = $('#centro').val();
                const jefeZona = $('#jefeZona').val();
                const ruta = $('#ruta').val();
                const cliente = $('#cliente').val();

                if (!cliente) return;

                const nombreNegocio = $('#nombreNegocio').val();
                const nombreCliente = $('#nombreCliente').val();
                const tipoClusterActual = $('#tipoCluster').val(); // puede ser "Razón Social"
                const direccion =
const codigoCliente = cliente.slice(0, 13);

                if (esCodigoRepetido(codigoCliente)) {
                    $('#mensajeRepetido').show();
                    return;
                }
                $('#mensajeRepetido').hide();

                const resultadoElement = $('#resultado');
                if (!allowAgregarPromorack) {
                    // Si no pasó verificación o no cumple reglas de excepción
                    $('#mensaje').show();
                    return;
                }

                // Detectar Razón Social por restricciones (para pintar y para mostrar)
                const restr = restricciones.find(r => r.Codigo === codigoCliente);
                const esRazonSocial = restr && (restr.No_Aplica_Por || "").toLowerCase().includes("razón social");

                // Valor a mostrar en la columna "Acción" (cluster/estado)
                // - Si se activó override (Razón Social + Mantener/Optimizar) usar texto especial
                // - Si es Razón Social normal, mostrar "Razón Social"
                // - Caso general: mostrar el cluster real
                const valorAccion = accionOverridePromorack
                    ? accionOverridePromorack
                    : (esRazonSocial ? 'Razón Social' : (tipoClusterActual || ''));

                const nuevoCliente = {
                    Centro: centro,
                    Jefe_Zona: jefeZona,
                    Ruta: ruta,
                    Codigo_Cliente: codigoCliente,
                    Nombre_de_Cliente: nombreNegocio,
                    Nombre_de_Negocio: nombreCliente,
                    Tipo_de_Cluster: valorAccion
                };

                clientesAgregados.push(nuevoCliente);

                // Determinar resaltado para la celda de acción
                const t = (valorAccion || '').toLowerCase();
                const resaltarAccion = (t === 'mantener' || t === 'optimizar' || t === 'razón social');

                const nuevaFila = `
                    <tr>
                        <td>${centro}</td>
                        <td>${jefeZona}</td>
                        <td>${ruta}</td>
                        <td>${codigoCliente}</td>
                        <td>${nombreNegocio}</td>
                        <td>${nombreCliente}</td>
                        <td class="${resaltarAccion ? 'highlight-background' : ''}">${valorAccion}</td>
                        <td><button class="remove-button">Eliminar</button></td>
                    </tr>
                `;

                $('#clientesAgregados tbody').append(nuevaFila);

                $('.remove-button').last().on('click', function() {
                    const index = $(this).closest('tr').index();
                    clientesAgregados.splice(index, 1);
                    $(this).closest('tr').remove();
                    if (clientesAgregados.length === 0) {
                        $('#descargarExcel').prop('disabled', true);
                    }
                    contadorPromorack--;
                    $('#contadorPromorack').text(`: ${contadorPromorack}`);
                    resetInputStyles();
                });

                resetInputStyles();

                // Reset form
                $('#cliente').val('').trigger('change');
                $('#ruta').val('');
                $('#nombreNegocio').val('');
                $('#nombreCliente').val('');
                $('#tipoCluster').val('');
$('#resultado').hide();
                $('#agregar').prop('disabled', true);
                $('#verificar').prop('disabled', true);
                $('#mensaje').hide();

                // Reset estado de agregado
                allowAgregarPromorack = false;
                accionOverridePromorack = null;

                if (clientesAgregados.length > 0) {
                    $('#descargarExcel').prop('disabled', false);
                }

                contadorPromorack++;
                $('#contadorPromorack').text(`: ${contadorPromorack}`);
            });

            $('#descargarExcel').on('click', function() {
                if (clientesAgregados.length === 0) {
                    alert("No hay clientes agregados para descargar.");
                    return;
                }

                const clientesParaExcel = clientesAgregados.map(cliente => {
                    const { Direccion, ...clienteSinDireccion } = cliente;
                    return clienteSinDireccion;
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(clientesParaExcel);
                XLSX.utils.book_append_sheet(wb, ws, "Clientes Agregados");
                XLSX.writeFile(wb, "clientes_agregados.xlsx");

                clientesAgregados = [];
                $('#clientesAgregados tbody').empty();
                $('#descargarExcel').prop('disabled', true);

                contadorPromorack = 0;
                $('#contadorPromorack').text(`: ${contadorPromorack}`);
            });

            $('#vaciarTablaPromorack').on('click', function() {
                clientesAgregados = [];
                $('#clientesAgregados tbody').empty();
                $('#descargarExcel').prop('disabled', true);
                contadorPromorack = 0;
                $('#contadorPromorack').text(`: ${contadorPromorack}`);
            });
        }

        function cargarDatosCambios(cambiosData, clientesSegmentacion, restricciones) {
            const centros = [...new Set(cambiosData.map(item => item.Centro))];
            const centroSelect = $('#centroCambios');
            centros.forEach(c => centroSelect.append(new Option(c, c)));

            centroSelect.select2().on('change', function() {
                const selectedCentro = $(this).val();
                const jefeZonaSelect = $('#jefeZonaCambios');

                jefeZonaSelect.empty().append('<option value="">Selecciona un jefe de zona</option>');
                $('#clienteCambios').empty().append('<option value="">Selecciona un cliente</option>').prop('disabled', true);
                $('#rutaCambios').val('');
                disableFields(['#jefeZonaCambios', '#clienteCambios']);

                if (selectedCentro) {
                    const jefesZona = [...new Set(cambiosData
                        .filter(item => item.Centro === selectedCentro)
                        .map(item => item.Jefe_Zona))];

                    jefesZona.forEach(j => jefeZonaSelect.append(new Option(j, j)));
                    jefeZonaSelect.prop('disabled', false).select2();
                }
            });

            $('#jefeZonaCambios').select2().on('change', function() {
                const selectedCentro = $('#centroCambios').val();
                const selectedJefeZona = $(this).val();
                const clienteSelect = $('#clienteCambios');

                clienteSelect.empty().append('<option value="">Selecciona un cliente</option>').prop('disabled', true);
                $('#rutaCambios').val('');
                disableFields(['#clienteCambios']);

                if (selectedCentro && selectedJefeZona) {
                    let clientes = [];
                    if (estadoBoton === 'Desactivar') {
                        clientes = [...new Set(cambiosData
                            .filter(item => item.Centro === selectedCentro && item.Jefe_Zona === selectedJefeZona)
                            .map(item => item.Codigo_Cliente_HTML))];
                    } else {
                        clientes = [...new Set(clientesSegmentacion
                            .filter(item => item.Centro === selectedCentro && item.Jefe_Zona === selectedJefeZona)
                            .map(item => item.Codigo_Cliente_HTML))];
                    }

                    clientes.forEach(c => clienteSelect.append(new Option(c, c)));
                    clienteSelect.prop('disabled', false).select2();
                    $('#verificarCambios').prop('disabled', true);
                    $('#agregarCambios').prop('disabled', true);
                }
            });

            $('#clienteCambios').select2().on('change', function() {
                const selectedCentro = $('#centroCambios').val();
                const selectedJefeZona = $('#jefeZonaCambios').val();
                const selectedCliente = $(this).val();

                if (!selectedCliente) {
                    $('#rutaCambios').val('');
                    $('#resultadoCambios').hide();
                    $('#verificarCambios').prop('disabled', true);
                    $('#agregarCambios').prop('disabled', true);
                    return;
                }

                const selectedClienteTruncado = selectedCliente.slice(0, 13);

                if (estadoBoton === 'Activar') {
                    $('#verificarCambios').prop('disabled', false).show();
                } else {
                    $('#agregarCambios').prop('disabled', false).show();
                }
                $('#resultadoCambios').hide();

                let clienteData;
                if (estadoBoton === 'Desactivar') {
                    clienteData = cambiosData.find(item => item.Codigo_Cliente_HTML.slice(0, 13) === selectedClienteTruncado);
                } else {
                    clienteData = clientesSegmentacion.find(item => 
                        item.Centro === selectedCentro && 
                        item.Jefe_Zona === selectedJefeZona && 
                        item.Codigo_Cliente_HTML.slice(0, 13) === selectedClienteTruncado
                    );
                }
                
                $('#rutaCambios').val(clienteData ? clienteData['Ruta'] : '');
            });

            $('#verificarCambios').on('click', function() {
                const selectedCentro = $('#centroCambios').val();
                const selectedJefeZona = $('#jefeZonaCambios').val();
                const selectedCliente = $('#clienteCambios').val();
                if (!selectedCliente) return;

                const selectedClienteTruncado = selectedCliente.slice(0, 13);

                let combina = [];
                if (estadoBoton === 'Desactivar') {
                    combina = cambiosData.filter(item => 
                        item.Centro === selectedCentro && 
                        item.Jefe_Zona === selectedJefeZona &&
                        item.Codigo_Cliente_HTML.slice(0, 13) === selectedClienteTruncado
                    );
                } else {
                    combina = clientesSegmentacion.filter(item => 
                        item.Centro === selectedCentro && 
                        item.Jefe_Zona === selectedJefeZona &&
                        item.Codigo_Cliente_HTML.slice(0, 13) === selectedClienteTruncado
                    );
                }

                const resultadoElement = $('#resultadoCambios');
                const agregarButton = $('#agregarCambios');
                const mensajeElement = $('#mensajeCambios');

                if (combina.length === 0) {
                    resultadoElement.text('No Aplica: Cliente no encontrado en la base de datos')
                        .removeClass('aplica').addClass('no-aplica').show();
                    agregarButton.prop('disabled', true);
                    mensajeElement.hide();
                    return;
                }

                if (estadoBoton === 'Activar') {
                    const restriccionesCliente = restricciones.find(item => item.Codigo === selectedClienteTruncado);
                    if (restriccionesCliente) {
                        resultadoElement.text('No Aplica: ' + restriccionesCliente.No_Aplica_Por)
                            .removeClass('aplica').addClass('no-aplica').show();
                        agregarButton.prop('disabled', true);
                        mensajeElement.show();
                        return;
                    }
                }

                resultadoElement.text('Aplica').removeClass('no-aplica').addClass('aplica').show();
                agregarButton.prop('disabled', false);
                mensajeElement.hide();
            });

            $('#agregarCambios').on('click', function() {
                const centro = $('#centroCambios').val();
                const jefeZona = $('#jefeZonaCambios').val();
                const ruta = $('#rutaCambios').val();
                const cliente = $('#clienteCambios').val();
                if (!cliente) return;

                const selectedClienteTruncado = cliente.slice(0, 13);

                let clienteData = {};
                if (estadoBoton === 'Desactivar') {
                    clienteData = cambiosData.find(item => 
                        item.Centro === centro && 
                        item.Jefe_Zona === jefeZona &&
                        item.Codigo_Cliente_HTML.slice(0, 13) === selectedClienteTruncado
                    );
                } else {
                    clienteData = clientesSegmentacion.find(item => 
                        item.Centro === centro && 
                        item.Jefe_Zona === jefeZona &&
                        item.Codigo_Cliente_HTML.slice(0, 13) === selectedClienteTruncado
                    );
                }

                const nuevoCambio = {
                    Centro: centro,
                    Jefe_Zona: jefeZona,
                    Ruta: ruta,
                    Codigo_Cliente: cliente.slice(0, 13),
                    Nombre_de_Cliente: clienteData ? clienteData.Nombre_de_Cliente : '',
                    Nombre_de_Negocio: clienteData ? clienteData.Nombre_de_Negocio : '',
                    Accion: estadoBoton
                };

                clientesAgregados.push(nuevoCambio);

                const nuevaFila = `
                    <tr>
                        <td>${centro}</td>
                        <td>${jefeZona}</td>
                        <td>${ruta}</td>
                        <td>${cliente.slice(0, 13)}</td>
                        <td>${clienteData ? clienteData.Nombre_de_Cliente : ''}</td>
                        <td>${clienteData ? clienteData.Nombre_de_Negocio : ''}</td>
                        <td>${estadoBoton}</td>
                        <td><button class="remove-button">Eliminar</button></td>
                    </tr>
                `;

                $('#clientesAgregados tbody').append(nuevaFila);

                $('.remove-button').last().on('click', function() {
                    const index = $(this).closest('tr').index();
                    if (estadoBoton === 'Activar') {
                        clientesAgregados = clientesAgregados.filter((_, i) => i !== index && i !== index - 1);
                        $(this).closest('tr').prev().remove();
                        $(this).closest('tr').remove();
                    } else {
                        clientesAgregados.splice(index, 1);
                        $(this).closest('tr').remove();
                    }

                    if (clientesAgregados.length === 0) {
                        $('#descargarExcelCambios').prop('disabled', true);
                    }
                    contadorCambios--;
                    $('#contadorCambios').text(`: ${Math.ceil(contadorCambios / 2)}`);
                });

                if (estadoBoton === 'Desactivar') {
                    $('#centroCambios').prop('disabled', true);
                    $('#verificarCambios').removeClass('btn-desactivar').addClass('btn-activar').text('Verificar').show();
                    $('#agregarCambios').removeClass('btn-desactivar').addClass('btn-activar').text('Activar');
                    estadoBoton = 'Activar';
                    $('#rutaCambios').val('');
                    $('#clienteCambios').val('').trigger('change');
                    $('#jefeZonaCambios').prop('disabled', false).trigger('change');
                } else {
                    $('#centroCambios').prop('disabled', false);
                    $('#verificarCambios').removeClass('btn-activar').addClass('btn-desactivar').text('Verificar').hide();
                    $('#agregarCambios').removeClass('btn-activar').addClass('btn-desactivar').text('Desactivar');
                    estadoBoton = 'Desactivar';
                    resetCambiosForm();
                }

                if (clientesAgregados.length > 0) {
                    $('#descargarExcelCambios').prop('disabled', false);
                }

                contadorCambios++;
                $('#contadorCambios').text(`: ${Math.ceil(contadorCambios / 2)}`);
            });

            $('#descargarExcelCambios').on('click', function() {
                if (clientesAgregados.length === 0) {
                    alert("No hay clientes agregados para descargar.");
                    return;
                }

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(clientesAgregados);
                XLSX.utils.book_append_sheet(wb, ws, "Clientes Agregados");
                XLSX.writeFile(wb, "clientes_agregados_cambios.xlsx");

                clientesAgregados = [];
                $('#clientesAgregados tbody').empty();
                $('#descargarExcelCambios').prop('disabled', true);

                contadorCambios = 0;
                $('#contadorCambios').text(`: ${contadorCambios}`);
            });

            $('#vaciarTablaCambios').on('click', function() {
                clientesAgregados = [];
                $('#clientesAgregados tbody').empty();
                $('#descargarExcelCambios').prop('disabled', true);
                contadorCambios = 0;
                $('#contadorCambios').text(`: ${contadorCambios}`);
            });
        }

        function resetInputStyles() {
            $('#nombreNegocio').removeClass('highlight-background').css('background-color', 'white');
            $('#nombreCliente').removeClass('highlight-background').css('background-color', 'white');
            $('#tipoCluster').removeClass('highlight-background').css('background-color', 'white');
}

        function resetCambiosForm() {
            $('#centroCambios').val('').trigger('change');
            $('#jefeZonaCambios').empty().append('<option value="">Selecciona un jefe de zona</option>').prop('disabled', true).trigger('change');
            $('#clienteCambios').empty().append('<option value="">Selecciona un cliente</option>').prop('disabled', true).trigger('change');
            $('#rutaCambios').val('');
            $('#resultadoCambios').hide();
            $('#agregarCambios').prop('disabled', true);
            $('#verificarCambios').prop('disabled', true).hide();
            $('#mensajeCambios').hide();
        }

        function disableFields(fields) {
            fields.forEach(field => $(field).prop('disabled', true));
        }

        $(document).ready(function() {
            loadData();

            $('#tabPromorack').on('click', function() {
                if (!$(this).hasClass('active')) {
                    $(this).addClass('active');
                    $('#tabCambios').removeClass('active');
                    $('#containerPromorack').addClass('active');
                    $('#containerCambios').removeClass('active');
                    $('#tabCambios').prop('disabled', false);
                    $('#tabPromorack').prop('disabled', true);
                }
            });

            $('#tabCambios').on('click', function() {
                if (!$(this).hasClass('active')) {
                    $(this).addClass('active');
                    $('#tabPromorack').removeClass('active');
                    $('#containerCambios').addClass('active');
                    $('#containerPromorack').removeClass('active');
                    $('#tabPromorack').prop('disabled', false);
                    $('#tabCambios').prop('disabled', true);
                }
            });
        });
    </script>
</body>
</html>
